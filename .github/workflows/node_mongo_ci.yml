name: node_mongo CI

on:
  pull_request:
  push:
    branches: [ main ]
    paths: [ node_mongo/** ]
  workflow_dispatch:

env:
  node_app_root: node_mongo

jobs:
  jest:

    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout the repo
        uses: actions/checkout@v4

      - name: Install modules
        run: |
          cd ${{ env.node_app_root }}
          npm install

      - name: Install Jest
        run: |
          cd ${{ env.node_app_root }}
          npm install --global jest

      - name: Run Jest
        run: |
          cd ${{ env.node_app_root }}
          jest --json --outputFile=jest_results.json

      - name: Test Summary
        run: |
          cd ${{ env.node_app_root }}
          echo '| Tests | Passed | Pending | Failed |' >> $GITHUB_STEP_SUMMARY
          echo '|:-----:|:------:|:-------:|:------:|' >> $GITHUB_STEP_SUMMARY
          echo '| ' $(jq '.numTotalTests' jest_results.json) ' | ' $(jq '.numPassedTests' jest_results.json) ' | ' $(jq '.numPendingTests' jest_results.json) ' | ' $(jq '.numFailedTests' jest_results.json) ' |' >> $GITHUB_STEP_SUMMARY
        if: always()
